name: Setup Virtual Container
description: >
  Set up a Linux container to use in workflow steps. Because the container is run inside a virtualized
  Alpine Linux distribution provided by jirutka/setup-alpine, the container can run on a different
  CPU architecture.
author: Sander Vocke

inputs:
  container:
    description: >
      URL of the container to use. It will be started using Podman.
    required: true
  arch:
    description: >
      CPU architecture to use.
    default: x86_64
  podman_args:
    description: >
      Additional arguments to podman.

runs:
  using: composite
  steps:
    - name: Install packages
      uses: ConorMacBride/install-package@v1
      with:
        apt: podman qemu qemu-user-static
    - name: Setup
      shell: bash
      run: |
        pwd
        ls -la
        sudo -E ./setup.sh
      working-directory: ${{ github.action_path }}
    - name: Run container
      uses: JarvusInnovations/background-action@v1
      with:
        run: |
         ARGS=""
         if [ ! -z "${{ inputs.arch }}" ]; then
           ARGS="$ARGS --arch ${{ inputs.arch }}"
         fi
         ARGS="$ARGS ${{ inputs.podman_args }}"
         CMD="podman run $ARGS --cidfile ${{ github.action_path }}/container_cid ${{ inputs.container }} /bin/sh -c 'sleep 100'"
         echo "Full podman command: $CMD"
         $CMD

        wait-on: ${{ github.action_path }}/container_cid
        wait-for: 5m
    - name: Get CID
      shell: bash
      run: |
        CID=$(cat ${{ github.action_path }}/container_cid)
        echo "__RUNNING_CONTAINER=$CID" >> $GITHUB_ENV
        echo "Container CID: $CID"